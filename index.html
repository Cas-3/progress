<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USPSA Classifier Progress</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            font-family: monospace;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-start;
        }
        button:hover {
            background-color: #0056b3;
        }
        #chart-container {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }
        .error {
            padding: 10px;
            background-color: #ffdddd;
            border-left: 5px solid #f44336;
            margin-bottom: 15px;
        }
        .instructions {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        .next-class-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e6f7ff;
            border-left: 5px solid #1890ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>USPSA Classifier Progress Tracker</h1>
        
        <div class="instructions">
            <h3>Instructions:</h3>
            <p>Paste your USPSA classifier data in TSV (Tab-Separated Values) format below. The data should include columns for Date and Percent at minimum.</p>
            <p>Example format:</p>
            <pre>Date	Number	Club	F	Percent	HF	Entered	Source
5/15/23	23-01	BRRC	8.43	57.8	4.87	Y	WM
6/20/23	22-09	BRRC	13.31	67.4	8.97	Y	WM</pre>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <textarea id="tsv-input" placeholder="Paste your TSV data here..."></textarea>
        
        <button id="process-btn">Process Data</button>
        
        <div id="next-class-info" class="next-class-info" style="display: none;"></div>
        
        <div id="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>
    
    <script>
        // Class bands definition (same as Python version)
        const classBands = {
            'GM': {threshold: 95, color: 'darkred'},
            'M':  {threshold: 85, color: 'purple'},
            'A':  {threshold: 75, color: 'blue'},
            'B':  {threshold: 60, color: 'green'},
            'C':  {threshold: 40, color: 'orange'},
            'D':  {threshold: 2,  color: 'gray'}
        };
        
        // Get class color based on score
        function getClassColor(score) {
            for (const [label, {threshold, color}] of Object.entries(classBands)) {
                if (score >= threshold) {
                    return color;
                }
            }
            return 'gray';
        }
        
        // Get current class and next class info based on score
        function getClassInfo(score) {
            let currentClass = 'U';
            let nextClass = 'D';
            let nextThreshold = 2;
            
            const sortedClasses = Object.entries(classBands)
                .sort((a, b) => b[1].threshold - a[1].threshold);
            
            for (const [label, {threshold}] of sortedClasses) {
                if (score >= threshold) {
                    currentClass = label;
                    break;
                }
                nextClass = label;
                nextThreshold = threshold;
            }
            
            return { currentClass, nextClass, nextThreshold };
        }
        
        // Process data and generate chart using regex
        document.getElementById('process-btn').addEventListener('click', function() {
            const textInput = document.getElementById('tsv-input').value.trim();
            const errorDiv = document.getElementById('error');
            const nextClassInfoDiv = document.getElementById('next-class-info');
            
            errorDiv.style.display = 'none';
            nextClassInfoDiv.style.display = 'none';
            
            if (!textInput) {
                errorDiv.textContent = "Please paste data first.";
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Parse with regex to extract date and percent values
                // This should be way more forgiving of formatting issues
                const lines = textInput.split(/[\r\n]+/).filter(line => line.trim().length > 0);
                const data = [];
                
                // Date pattern: matches m/d/yy, mm/dd/yyyy, etc.
                const datePattern = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/;
                
                // Number pattern: matches floating point numbers like 75.2, 75,2, etc.
                const numberPattern = /(\d+[.,]\d+)/g;
                
                for (const line of lines) {
                    // Skip header line if it contains text like "Date" and "Percent"
                    if (line.match(/Date|Percent|Number|Club/i) && !line.match(datePattern)) {
                        continue;
                    }
                    
                    // Try to find a date
                    const dateMatch = line.match(datePattern);
                    if (!dateMatch) continue;
                    
                    // Extract all numbers from the line
                    const numbers = [];
                    let match;
                    while ((match = numberPattern.exec(line)) !== null) {
                        numbers.push(parseFloat(match[0].replace(',', '.')));
                    }
                    
                    // Reset regex lastIndex
                    numberPattern.lastIndex = 0;
                    
                    // We need at least one number for the percent
                    if (numbers.length === 0) continue;
                    
                    // Look for a percentage value (typically the 5th value)
                    // Usually it's the 5th entry but we'll also look for values between 0-100
                    let percent;
                    
                    // Try to find a value between 0-100 which is likely the percent
                    // Most classifier scores are between 40-95%
                    for (const num of numbers) {
                        if (num >= 0 && num <= 100) {
                            percent = num;
                            break;
                        }
                    }
                    
                    // If no valid percent found, skip this line
                    if (percent === undefined) continue;
                    
                    // Parse the date
                    let date;
                    const month = parseInt(dateMatch[1]);
                    const day = parseInt(dateMatch[2]);
                    let year = parseInt(dateMatch[3]);
                    
                    // Handle 2-digit years
                    if (year < 100) {
                        year = year < 50 ? 2000 + year : 1900 + year;
                    }
                    
                    date = new Date(year, month - 1, day);
                    
                    // Add to data if we have valid date and percent
                    if (!isNaN(date.getTime()) && !isNaN(percent)) {
                        data.push({
                            Date: `${month}/${day}/${year}`,
                            DateObj: date,
                            Percent: percent
                        });
                    }
                }
                
                if (data.length === 0) {
                    throw new Error("Could not find any valid date and percent pairs in the data.");
                }
                
                if (data.length === 0) {
                    throw new Error("No valid data found after parsing. Check your date and percent formats.");
                }
                
                // Sort by date
                data.sort((a, b) => a.DateObj - b.DateObj);
                
                // Compute rolling averages (best 6 of 8)
                const rollingAvgs = [];
                const dates = [];
                const colors = [];
                
                for (let i = 1; i <= data.length; i++) {
                    const recent = data.slice(0, i).slice(-8);
                    if (recent.length < 4) continue;
                    
                    // Get best 6 scores
                    const best6 = [...recent].sort((a, b) => b.Percent - a.Percent).slice(0, 6);
                    const avg = best6.reduce((sum, row) => sum + row.Percent, 0) / 6;
                    
                    rollingAvgs.push(avg);
                    dates.push(recent[recent.length - 1].DateObj);
                    colors.push(getClassColor(avg));
                }
                
                // Calculate next class info
                if (rollingAvgs.length > 0) {
                    const currentAvg = rollingAvgs[rollingAvgs.length - 1];
                    const { currentClass, nextClass, nextThreshold } = getClassInfo(currentAvg);
                    
                    // Calculate what's needed for next class
                    let nextClassInfo = "";
                    
                    if (currentClass === 'GM') {
                        nextClassInfo = "Congratulations! You've reached Grandmaster classification!";
                    } else {
                        // Calculate what score is needed on next classifier to reach next class
                        // Formula: (Needed Avg * 6) - (Current Avg * 5) = Score needed
                        const scoreNeeded = (nextThreshold * 6) - (currentAvg * 5);
                        
                        if (scoreNeeded > 100) {
                            nextClassInfo = `To reach ${nextClass} class, you need: ${scoreNeeded.toFixed(2)}% on your next classifier. Good luck!`;
                        } else {
                            nextClassInfo = `To reach ${nextClass} class, you need: ${scoreNeeded.toFixed(2)}% on your next classifier.`;
                        }
                    }
                    
                    nextClassInfoDiv.textContent = nextClassInfo;
                    nextClassInfoDiv.style.display = 'block';
                }
                
                // Create the chart manually with SVG
                const svgOutput = createSVGChart(data, dates, rollingAvgs, colors);
                document.getElementById('chart-container').innerHTML = svgOutput;
                
            } catch (e) {
                errorDiv.textContent = `Error processing data: ${e.message}`;
                errorDiv.style.display = 'block';
            }
        });
        
        function createSVGChart(data, dates, rollingAvgs, colors) {
            // Set dimensions
            const width = 900;
            const height = 500;
            const margin = { top: 50, right: 50, bottom: 70, left: 70 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Find date range
            const minDate = data[0].DateObj;
            const maxDate = data[data.length - 1].DateObj;
            const timeRange = maxDate - minDate;
            
            // Create scale functions
            function xScale(date) {
                return margin.left + (innerWidth * (date - minDate) / timeRange);
            }
            
            function yScale(value) {
                return margin.top + innerHeight - (innerHeight * value / 100);
            }
            
            // Start SVG
            let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            // Add background grid
            svg += `<g class="grid">`;
            // Horizontal lines every 10%
            for (let i = 0; i <= 100; i += 10) {
                const y = yScale(i);
                svg += `<line x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" 
                        stroke="#dddddd" stroke-width="1" stroke-dasharray="5,5" />`;
                svg += `<text x="${margin.left - 10}" y="${y + 5}" text-anchor="end" font-size="12">${i}%</text>`;
            }
            
            // Vertical lines (roughly every month)
            const months = Math.max(1, Math.ceil(timeRange / (30 * 24 * 60 * 60 * 1000)));
            const step = timeRange / months;
            for (let i = 0; i <= months; i++) {
                const date = new Date(minDate.getTime() + i * step);
                const x = xScale(date);
                svg += `<line x1="${x}" y1="${margin.top}" x2="${x}" y2="${height - margin.bottom}" 
                        stroke="#dddddd" stroke-width="1" stroke-dasharray="5,5" />`;
                const monthYear = date.toLocaleDateString(undefined, { month: 'short', year: '2-digit' });
                svg += `<text x="${x}" y="${height - margin.bottom + 20}" text-anchor="middle" font-size="12">${monthYear}</text>`;
            }
            svg += `</g>`;
            
            // Draw class lines
            Object.entries(classBands).forEach(([label, {threshold, color}]) => {
                const y = yScale(threshold);
                svg += `<line x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" 
                        stroke="${color}" stroke-width="2" stroke-dasharray="5,5" />`;
                svg += `<text x="${width - margin.right + 10}" y="${y + 5}" font-size="12" fill="${color}">${label}</text>`;
            });
            
            // Draw raw scores line (without dots)
            svg += `<polyline points="`;
            data.forEach(row => {
                svg += `${xScale(row.DateObj)},${yScale(row.Percent)} `;
            });
            svg += `" fill="none" stroke="blue" stroke-width="1" opacity="0.3" />`;
            
            // Draw rolling avg line
            if (dates.length > 1) {
                svg += `<polyline points="`;
                dates.forEach((date, i) => {
                    svg += `${xScale(date)},${yScale(rollingAvgs[i])} `;
                });
                svg += `" fill="none" stroke="black" stroke-width="2" opacity="0.7" />`;
            }
            
            // Draw colored points for rolling avg
            dates.forEach((date, i) => {
                const x = xScale(date);
                const y = yScale(rollingAvgs[i]);
                svg += `<circle cx="${x}" cy="${y}" r="7" fill="${colors[i]}" stroke="black" />`;
                
                // Add tooltip on hover
                svg += `<g>
                    <circle cx="${x}" cy="${y}" r="12" fill="transparent" />
                    <title>Date: ${date.toLocaleDateString()} - Avg: ${rollingAvgs[i].toFixed(2)}%</title>
                </g>`;
            });
            
            // Add title and labels
            svg += `<text x="${width/2}" y="25" text-anchor="middle" font-size="16" font-weight="bold">USPSA Classifier Progress</text>`;
            svg += `<text x="${width/2}" y="${height - 15}" text-anchor="middle" font-size="14">Date</text>`;
            svg += `<text x="20" y="${height/2}" text-anchor="middle" font-size="14" transform="rotate(-90 20,${height/2})">Classifier Average (%)</text>`;
            
            // Add legend
            const legendX = margin.left;
            const legendY = margin.top - 15;
            
            // Raw score legend
            svg += `<circle cx="${legendX}" cy="${legendY}" r="4" fill="blue" opacity="0.5" />`;
            svg += `<text x="${legendX + 10}" y="${legendY + 5}" font-size="12">Raw Scores</text>`;
            
            // Class legend
            let classLegendX = legendX + 120;
            Object.entries(classBands).forEach(([label, {color}]) => {
                svg += `<circle cx="${classLegendX}" cy="${legendY}" r="7" fill="${color}" stroke="black" />`;
                svg += `<text x="${classLegendX + 10}" y="${legendY + 5}" font-size="12">${label} Class</text>`;
                classLegendX += 80;
            });
            
            // End SVG
            svg += `</svg>`;
            return svg;
        }
    </script>
</body>
</html>
